# 18-Category Comprehensive Audit

**Date:** 2026-02-01
**Version:** 0.1.16
**Codebase:** ~6500 lines across 11 modules
**Tests:** 54 passing

---

## Summary Matrix

| # | Category | Critical | High | Medium | Low | Total |
|---|----------|----------|------|--------|-----|-------|
| 1 | Security | 1 | 1 | 2 | 2 | 6 |
| 2 | Error Handling | 0 | 0 | 2 | 2 | 4 |
| 3 | Performance | 0 | 1 | 3 | 2 | 6 |
| 4 | Memory Safety | 0 | 0 | 1 | 2 | 3 |
| 5 | Concurrency | 0 | 1 | 1 | 1 | 3 |
| 6 | API Design | 0 | 0 | 2 | 3 | 5 |
| 7 | Code Quality | 0 | 0 | 1 | 4 | 5 |
| 8 | Testing | 0 | 1 | 2 | 2 | 5 |
| 9 | Documentation | 0 | 0 | 1 | 3 | 4 |
| 10 | Dependencies | 0 | 1 | 3 | 1 | 5 |
| 11 | Configuration | 0 | 0 | 1 | 2 | 3 |
| 12 | Logging & Observability | 0 | 0 | 2 | 2 | 4 |
| 13 | Compatibility | 0 | 0 | 1 | 2 | 3 |
| 14 | Maintainability | 0 | 0 | 1 | 3 | 4 |
| 15 | User Experience | 0 | 0 | 2 | 3 | 5 |
| 16 | Deployment & Operations | 0 | 0 | 2 | 2 | 4 |
| 17 | Community | 0 | 0 | 1 | 3 | 4 |
| 18 | Promotion | 0 | 0 | 2 | 2 | 4 |
| **Total** | | **1** | **5** | **29** | **42** | **77** |

---

## Changes Since Last Audit (2026-01-31)

**Added:**
- `src/hunch.rs` - New hunch parsing module (297 lines)
- Schema v6 with hunches table + FTS5
- `cqs_read` MCP tool for context-injected file reads
- Unified search across code + hunches

**Fixed from previous audit:**
- Q7.1 - All clippy warnings resolved
- P3.1 - HNSW index now implemented
- P3.4 - r2d2 connection pooling added
- D10.2/D10.3 - glob/fs2 replaced (now using globset/fs4)

**New issues found:**
- S1.NEW - Path traversal in cqs_read (CRITICAL)
- D10.NEW - bincode unmaintained (from hnsw_rs)

---

## 1. Security

### CRITICAL

**S1.NEW: Path traversal in cqs_read tool**
- **Location:** `mcp.rs:563`
- **Issue:** `tool_read` joins user-provided path without validation
- **Exploit:** `{"path": "../../../etc/passwd"}` reads outside project
- **Fix:** Add canonicalize + starts_with check (same as cli.rs:321-322)
```rust
let file_path = self.project_root.join(path).canonicalize()?;
if !file_path.starts_with(&self.project_root) {
    bail!("Path traversal detected");
}
```

### HIGH

**S1.1: SQL string interpolation in language filter**
- **Location:** `store.rs:407-408`
- **Issue:** Language filter uses string formatting in SQL
- **Status:** Still present - Language enum constrains values but pattern is dangerous
- **Fix:** Use parameterized query with `params_from_iter`

### MEDIUM

**S1.3: UUID generation uses timestamp only**
- **Location:** `mcp.rs:590-596`
- **Issue:** `uuid_simple()` uses nanoseconds only - predictable
- **Fix:** Add random component or use `uuid` crate

**S1.4: No rate limiting on HTTP transport**
- **Location:** `mcp.rs:442-471`
- **Issue:** No request rate limiting on `/mcp` endpoint
- **Fix:** Add `tower::limit::RateLimitLayer`

### LOW

**S1.5: File lock path is predictable**
- **Location:** `cli.rs:288`
- **Issue:** Lock file at `.cq/index.lock` is predictable

**S1.6: No Content-Security-Policy header**
- **Location:** `mcp.rs:448-451`
- **Issue:** HTTP transport doesn't set CSP headers

---

## 2. Error Handling

### MEDIUM

**E2.1: Panic in Parser::default()**
- **Location:** `parser.rs:401`
- **Issue:** `expect("failed to create parser")` will panic
- **Fix:** Return Result or use `Default` only where infallible

**E2.2: Silent failures in search scoring loops**
- **Location:** `store.rs:435-436`, `store.rs:1444`
- **Issue:** `filter_map(|r| r.ok())` silently drops database errors
- **Note:** Now affects both code search AND hunch search
- **Fix:** Log dropped errors or propagate first error

### LOW

**E2.3: Unwrap in embed_query**
- **Location:** `embedder.rs:111`
- **Issue:** `.unwrap()` after empty check - safe but unclear

**E2.4: Default date fallback in hunch parsing**
- **Location:** `hunch.rs:203-204`
- **Issue:** Invalid dates silently become 2000-01-01
- **Fix:** Return error or log warning

---

## 3. Performance

### HIGH

**P3.2: No embedding cache**
- **Location:** `embedder.rs:130-214`
- **Issue:** Same query embedded multiple times in a session
- **Fix:** LRU cache for recent query embeddings

### MEDIUM

**P3.3: Tokenizer created per batch**
- **Location:** `embedder.rs:138-141`
- **Issue:** `encode_batch` allocates new strings for every batch

**P3.5: Naive cosine similarity**
- **Location:** `store.rs:152-154`
- **Issue:** Plain Rust loop, no SIMD
- **Note:** Less critical now that HNSW limits comparisons

**P3.6: Full file read for context**
- **Location:** `cli.rs:940-971`
- **Issue:** Reads entire file just to get N context lines

### LOW

**P3.7: Regex compilation in name_match_score**
- **Location:** `store.rs:194-216`
- **Issue:** `tokenize_identifier` creates strings for every comparison

**P3.8: Stats query inefficiency**
- **Location:** `store.rs:560-638`
- **Issue:** Multiple separate queries instead of single JOIN

---

## 4. Memory Safety

### MEDIUM

**M4.1: Unbounded chunk content size**
- **Location:** `parser.rs:199-208`
- **Issue:** 100-line limit but no character limit per line

### LOW

**M4.2: Vec allocation in pad_2d_i64**
- **Location:** `embedder.rs:308-317`
- **Issue:** Creates dense array for variable-length sequences

**M4.3: Clone in search results**
- **Location:** `store.rs:510-514`
- **Issue:** `row.clone()` for every result

---

## 5. Concurrency

### HIGH

**C5.1: Mutex contention in HTTP handler**
- **Location:** `mcp.rs:522-525`
- **Issue:** Single `Mutex<McpServer>` serializes all queries
- **Fix:** Use `RwLock` (search is read-only)

### MEDIUM

**C5.2: Watch mode race condition**
- **Location:** `cli.rs:700-766`
- **Issue:** Debounce window could miss rapid successive edits

### LOW

**C5.3: AtomicBool ordering**
- **Location:** `cli.rs:37,41,51`
- **Issue:** Uses `SeqCst` where `Relaxed` or `Acquire/Release` sufficient

---

## 6. API Design

### MEDIUM

**A6.1: Store requires mutable borrow for search**
- **Location:** `store.rs:386-394`
- **Issue:** API design could be clearer about mutability

**A6.2: Embedding type is just Vec wrapper**
- **Location:** `embedder.rs:44-45`
- **Issue:** `Embedding(pub Vec<f32>)` exposes internal representation

### LOW

**A6.3: SearchFilter uses owned String**
- **Location:** `store.rs:94-102`
- **Fix:** Lifetime parameter or `Cow<'a, str>`

**A6.4: No builder for Embedder**
- **Location:** `embedder.rs:72-92`
- **Fix:** Add `EmbedderBuilder`

**A6.5: Hunch struct has public fields**
- **Location:** `hunch.rs:142-159`
- **Issue:** All fields public, could add accessors

---

## 7. Code Quality

### MEDIUM

**Q7.2: Dead code warnings suppressed**
- **Location:** `mcp.rs:31,63`, `cli.rs:26`
- **Issue:** `#[allow(dead_code)]` on request fields

### LOW

**Q7.3: Magic numbers**
- **Locations:** Various hardcoded values
- **Fix:** Move to config or document

**Q7.4: Long functions**
- **Location:** `cmd_index` (170 lines), `search_filtered` (120 lines)
- **Fix:** Extract logical sections

**Q7.5: Inconsistent error types**
- **Issue:** Mix of `anyhow::Error` and custom enums

**Q7.6: Stringly-typed data in ChunkRow**
- **Location:** `store.rs`
- **Status:** Acceptable, parsed in `ChunkSummary::from`

---

## 8. Testing

### HIGH

**T8.1: No integration tests for MCP protocol**
- **Issue:** MCP handlers tested manually but no automated tests
- **Risk:** Protocol regressions, format issues
- **Note:** cqs_read tool is completely untested

### MEDIUM

**T8.2: No embedder tests**
- **Issue:** Embedder requires model download - skipped in CI

**T8.3: Limited edge case coverage**
- **Missing tests:**
  - Non-UTF8 file handling
  - Symlink behavior
  - Path traversal in cqs_read
  - Hunch search edge cases

### LOW

**T8.4: No property-based testing**
- **Issue:** Could benefit from proptest for parser/hunch parsing

**T8.5: Eval test hardcoded paths**
- **Location:** `tests/eval_test.rs`

---

## 9. Documentation

### MEDIUM

**D9.1: No rustdoc on public API**
- **Issue:** `pub` items in lib.rs lack `///` documentation
- **Note:** hunch.rs has good rustdoc (set the example)

### LOW

**D9.2: Complex functions lack inline comments**
- **Locations:** `extract_chunk`, `search_filtered`, `embed_batch`

**D9.3: MCP protocol version inconsistency**
- **Location:** `mcp.rs:206-207`
- **Issue:** Returns different version than header

**D9.4: No changelog**
- **Issue:** No CHANGELOG.md file

---

## 10. Dependencies

### HIGH

**D10.1: ort 2.x is still RC**
- **Version:** `2.0.0-rc.11`
- **Risk:** API changes, less security scrutiny

### MEDIUM

**D10.NEW: bincode unmaintained**
- **Version:** `1.3.3`
- **Advisory:** RUSTSEC-2025-0141
- **Source:** Transitive via hnsw_rs
- **Action:** Monitor hnsw_rs for updates

**D10.NEW2: number_prefix unmaintained**
- **Advisory:** In cargo audit output
- **Source:** Transitive dependency

**D10.4: tree-sitter version gap**
- **Issue:** Using tree-sitter 0.26 with grammar crates at 0.23-0.25
- **Status:** Works via abstraction layer

### LOW

**D10.5: Large dependency tree**
- **Count:** 412 crate dependencies
- **Note:** Mostly from ort/tree-sitter - acceptable

---

## 11. Configuration

### MEDIUM

**CF11.1: No config file support**
- **Issue:** All config via CLI flags; no `.cqsrc` or similar

### LOW

**CF11.2: No environment variable overrides**
- **Issue:** Can't set defaults via `CQS_*` env vars

**CF11.3: Hardcoded model selection**
- **Location:** `embedder.rs:10-12`

---

## 12. Logging & Observability

### MEDIUM

**L12.1: No structured logging**
- **Issue:** Uses `tracing` but only `warn!` calls, no spans

**L12.2: No metrics**
- **Issue:** No timing or count metrics exposed

### LOW

**L12.3: Verbose tracing in hot path**
- **Location:** `parser.rs:202-206`

**L12.4: No request ID in HTTP**
- **Location:** `mcp.rs:473-533`

---

## 13. Compatibility

### MEDIUM

**CM13.1: No Windows path handling**
- **Issue:** Uses `/` separators, may break on Windows native

### LOW

**CM13.2: CUDA-specific GPU paths**
- **Issue:** Only CUDA/TensorRT supported

**CM13.3: SQLite bundled assumption**
- **Location:** `Cargo.toml:40`

---

## 14. Maintainability

### MEDIUM

**MT14.1: No module-level architecture docs**
- **Issue:** Relationships between modules undocumented

### LOW

**MT14.2: Tight coupling in CLI**
- **Issue:** `cli.rs` directly instantiates all components

**MT14.3: No feature flags**
- **Issue:** All features always compiled

**MT14.4: Mixed concerns in McpServer**
- **Issue:** Protocol handling + business logic in same struct

---

## 15. User Experience

### MEDIUM

**UX15.1: No interactive mode**
- **Issue:** Each query requires full model load

**UX15.2: Error messages lack suggestions**
- **Example:** "Index not found" doesn't suggest fix

### LOW

**UX15.3: No shell completion**
- **Issue:** No bash/zsh/fish completions

**UX15.4: Progress bar on stderr**
- **Issue:** Progress bar mixes with tracing output

**UX15.5: No color control flag**
- **Issue:** No `--color=auto|always|never`

---

## 16. Deployment & Operations

### MEDIUM

**DO16.1: No health check in stdio mode**
- **Issue:** Can't verify MCP server is alive in stdio mode

**DO16.2: No graceful shutdown in HTTP**
- **Location:** `mcp.rs:463-468`

### LOW

**DO16.3: Lock file not cleaned on crash**
- **Issue:** `.cq/index.lock` persists after crash

**DO16.4: No version check on start**
- **Issue:** Doesn't warn if binary is older than index

---

## 17. Community

### MEDIUM

**CO17.1: Prefer existing dependencies over new ones**
- **Good:** Used `toml` (already present) for hunches.toml
- **Check:** Before adding a dep, ask: can an existing dep do this?

### LOW

**CO17.2: Follow Rust ecosystem conventions**
- **Good:** Using `thiserror`/`anyhow` pattern
- **Good:** Cargo.toml follows standard layout

**CO17.3: Minimize breaking changes**
- **Current:** Pre-1.0, breaking changes acceptable

**CO17.4: Contribute upstream**
- **Opportunity:** bincode issue in hnsw_rs - could file issue

---

## 18. Promotion

### MEDIUM

**PR18.1: Discoverability gaps**
- **crates.io:** Published - `cargo install cqs` works
- **GitHub topics:** Should add relevant topics

**PR18.2: Documentation accessibility**
- **README:** Good but long
- **Examples:** Add examples/ directory

### LOW

**PR18.3: Social proof**
- **Status:** Early stage, organic growth

**PR18.4: Onboarding friction**
- **Status:** `cargo install cqs` works now

---

## Priority Recommendations

### Must Fix (Before PR #45 merges)

1. **S1.NEW** - Path traversal in cqs_read - CRITICAL

### Should Fix (v0.2.0)

2. **S1.1** - SQL string interpolation â†’ parameterized query
3. **C5.1** - RwLock for HTTP handler
4. **T8.1** - Add MCP protocol integration tests
5. **P3.2** - Query embedding cache

### Nice to Have (Future)

6. **CF11.1** - Config file support
7. **UX15.1** - REPL mode
8. **L12.1** - Structured logging with spans

---

## Verified Safe

- [x] No SQL injection (parameterized queries in data paths)
- [x] No command injection (no shell execution)
- [ ] **Path traversal in cqs_read - NEEDS FIX**
- [x] File size limits enforced
- [x] Non-UTF8 files handled gracefully
- [x] SIGINT handled cleanly
- [x] WAL mode for crash safety
- [x] Checksums verified on model download
- [x] All tests passing (54)
- [x] Clippy clean
- [ ] Dependencies have warnings (bincode, number_prefix unmaintained)

---

## Audit Methodology

- Full source code review (~6500 lines)
- `cargo clippy` analysis (clean)
- `cargo test` verification (54 tests passing)
- `cargo audit` dependency check
- MCP spec compliance check
- Path traversal manual testing
- Cross-reference with previous audit (2026-01-31)

**Auditor:** Claude Opus 4.5
**Date:** 2026-02-01
