# Notes - unified memory for AI collaborators
# Surprises (prediction errors) worth remembering
# sentiment: DISCRETE values only: -1, -0.5, 0, 0.5, 1
#   -1 = serious pain, -0.5 = notable pain, 0 = neutral, 0.5 = notable gain, 1 = major win

[[note]]
sentiment = -0.5
text = 'trailing_var_arg in clap eats flags after the query. `cqs "foo" -n 5` parses as query "foo -n 5". Removed it - users quote multi-word queries, flags work anywhere.'
mentions = [
    "src/cli/mod.rs",
    "clap",
]

[[note]]
sentiment = -0.5
text = "gh pr checks exit code returns 1 if ANY check is pending or skipped, even if critical ones passed. Don't trust exit code - parse output or use --watch."
mentions = [
    "gh",
    "CI",
    "github",
]

[[note]]
sentiment = -0.5
text = "WSL /mnt/c/ path causes random permission errors (libsqlite3-sys, git config). Workaround in .cargo/config.toml but might bite elsewhere."
mentions = [
    ".cargo/config.toml",
    "libsqlite3-sys",
]

[[note]]
sentiment = 0.0
text = "hnsw_rs uses bincode 1.3.3 (unmaintained, RUSTSEC-2025-0141). Mitigated with blake3 checksums on save/load. verify_hnsw_checksums validates extension allowlist to prevent path traversal."
mentions = [
    "src/hnsw/persist.rs",
    "hnsw_rs",
    "bincode",
    "blake3",
]

[[note]]
sentiment = 0.5
text = "769th embedding dimension can encode explicit sentiment. Similarity search then weights by feeling automatically. Breaking schema change but enables sentiment-aware retrieval."
mentions = [
    "src/embedder.rs",
    "src/store/mod.rs",
    "src/hnsw/mod.rs",
]

[[note]]
sentiment = 1.0
text = "Git as team sync layer. Commit notes.toml, push/pull handles sync. Access control = repo permissions. History = blame. Conflict resolution = merge. No infrastructure needed."
mentions = [
    "notes.toml",
    "tears",
]

[[note]]
sentiment = 1.0
text = "cuVS CAGRA: 8-12x faster index builds, 4-8x faster search vs CPU HNSW. Rust bindings exist (cuvs crate). Feature-flagged as gpu-search for CUDA-equipped infrastructure."
mentions = [
    "src/hnsw/mod.rs",
    "Cargo.toml",
]

[[note]]
sentiment = 0.5
text = "Copilot+ PC is a hardware contract for AI workloads - guarantees NPU with 40+ TOPS, DirectML, Phi Silica. ort crate has DirectML execution provider. If we detect Copilot+ runtime, could use NPU path instead of CUDA/CPU. Third acceleration tier after GPU and CPU."
mentions = [
    "embedder.rs",
    "ort",
    "DirectML",
]

[[note]]
sentiment = 0.5
text = "5-point sentiment scale (-1, -0.5, 0, 0.5, 1) beats 21-point (0.1 increments). Coarser is clearer - no false precision. When writing -0.6 vs -0.7, the distinction wasn't meaningful anyway."
mentions = [
    "notes.toml",
    "sentiment",
]

[[note]]
sentiment = -0.5
text = "cuvs-sys crate uses find_package(cuvs), not source build. Needs libcuvs pre-installed via conda or manual RAPIDS build. Not self-contained like expected."
mentions = [
    "cuvs",
    "Cargo.toml",
    "gpu-search",
]

[[note]]
sentiment = 0.0
text = "CI catches what local builds miss. Feature flags differ between dev (gpu-search enabled) and CI (default features). Clippy on CI found dead code invisible locally."
mentions = [
    "CI",
    "clippy",
    "features",
]

[[note]]
sentiment = 0.5
text = "Pre-commit hook catches fmt issues before CI roundtrip. Fast feedback loop. Worth the setup."
mentions = [
    ".githooks",
    "cargo fmt",
]

[[note]]
sentiment = -0.5
text = "batch_size=64 crashed system at ~2% through rust-lang/rust. batch_size=32 runs stable. With 2048-token windowing, GPU util cycles 0-99% (bursty) as it waits for ort CPU fallback ops between batches."
mentions = [
    "src/cli/mod.rs",
    "batch_size",
    "gpu-search",
]

[[note]]
sentiment = -0.5
text = "ort CUDA provider fails silently if libs not in LD_LIBRARY_PATH. No error - just falls back to CPU. The log shows 'Adding default CPU execution provider' instead of CUDA. Must include ~/.cache/ort.pyke.io/dfbin/.../  in LD_LIBRARY_PATH."
mentions = [
    "ort",
    "CUDA",
    "LD_LIBRARY_PATH",
    "embedder.rs",
]

[[note]]
sentiment = -0.5
text = "Don't make up numbers. Git history is right there: `git log --reverse --format='%ai' | head -1`. Check facts instead of guessing."
mentions = ["git"]

[[note]]
sentiment = 0.5
text = "Put token count in filename for large files (e.g., DESIGN_SPEC_27k_tokens.md). Claude sees it in glob results and knows to chunk or skip. Metadata in the filesystem."
mentions = [
    "docs/",
    "workflow",
]

[[note]]
sentiment = 0.5
text = "Notes surface heavily in search results because they contain dense semantic content about architecture decisions. That's intentional - observations are indexed to be found when conceptually relevant."
mentions = [
    "notes.toml",
    "src/store/mod.rs",
    "search",
]

[[note]]
sentiment = 0.5
text = "--name-boost 0.8 for precision when you know partial function name. Default 0.2 favors semantic. Crank it up when searching for specific identifiers vs concepts."
mentions = [
    "src/cli/mod.rs",
    "name_boost",
    "hybrid search",
]

[[note]]
sentiment = 1.0
text = "Hybrid CAGRA startup: HNSW loads in 30ms, CAGRA builds in background (~1.2s), auto-swaps via Arc<RwLock>. Non-blocking startup pattern for GPU index builds."
mentions = [
    "src/cagra.rs",
    "src/hnsw/mod.rs",
    "startup",
]

[[note]]
sentiment = 0.5
text = "sqlx migration complete: replaced rusqlite/r2d2 with sqlx async SQLite. Key design choice: sync wrappers via internal Runtime::block_on() preserve existing API. Schema init needed fix: split SQL by semicolons AND skip leading comment-only lines (not just statements that start with --)."
mentions = [
    "src/store/mod.rs",
    "Cargo.toml",
]

[[note]]
sentiment = 1.0
text = "Streaming HNSW build for large repos: Store::embedding_batches() yields chunks in 10k batches via cursor pagination (WHERE rowid > N), HnswIndex::build_batched() inserts incrementally. Memory drops from O(n) to O(batch_size). Fixes #107 OOM on huge repos."
mentions = [
    "src/store/chunks.rs",
    "src/hnsw/build.rs",
    "embedding_batches",
    "build_batched",
]

[[note]]
sentiment = 0.5
text = "note_weight parameter added to SearchFilter. Default 1.0, lower values attenuate note scores before merging with code results. CLI --note-weight flag. Useful when notes dominate due to high semantic match."
mentions = [
    "SearchFilter",
    "src/search.rs",
    "src/cli/mod.rs",
]

[[note]]
sentiment = 0.5
text = "Embedding model: E5-base-v2, chosen for CUDA compatibility (absolute position embeddings, no rotary). Eval showed E5-base, BGE-base, E5-large all at 100% Recall@5 — saturated, no reason to switch. Any replacement must be BERT-style to avoid ort Gather op CPU fallback."
mentions = [
    "src/embedder.rs",
    "CUDA",
    "model selection",
    "E5",
]

[[note]]
sentiment = -1.0
text = "Glob filter BEFORE heap was the #1 correctness bug from the 20-category audit. Brute-force search applied glob AFTER selecting top-k from heap, meaning filtered results could miss relevant chunks that were displaced by non-matching ones. Always filter before ranking."
mentions = [
    "src/search.rs",
    "glob",
    "brute-force",
    "algorithm correctness",
]

[[note]]
sentiment = 0.5
text = "note_weight=0 bug: documented as 'excludes notes from results' but only zeroed scores - notes still appeared. Caught by test_search_unified_note_weight_zero_excludes_notes. Tests that assert absence (not just presence) find real bugs. Write negative-case tests."
mentions = [
    "src/search.rs",
    "SearchFilter",
    "note_weight",
    "testing",
]

[[note]]
sentiment = 1.0
text = "Audits consistently find real bugs. History: 10-category (v0.4): 16 issues closed, proptest found RRF bound bug. 20-category v1 (v0.5.1): ~85 actionable from ~120 raw, 3 PRs for P1-P3, 13 P4 issues. 20-category v2 (v0.6.0): ~120 unique from 193 raw, 28 fixes across P1-P3 (PRs #259, #261, #262, #263), 7 issues for remaining items. Key: 5 parallel agents per batch, audit mode on, collect ALL findings before fixing ANY. Batch by priority tier."
mentions = [
    "docs/audit-findings.md",
    "audit",
    "workflow",
]

[[note]]
sentiment = -0.5
text = "Heredoc in `gh pr create --body` gets captured as a permission entry in .claude/settings.local.json, causing parse errors on next startup. Fix: always write PR/release bodies to a temp file and use --body-file instead of inline heredocs. The multiline content gets serialized into the permissions allow list as a malformed Bash() entry."
mentions = [
    "settings.local.json",
    "gh pr create",
    "powershell.exe",
    "heredoc",
]

[[note]]
sentiment = 1.0
text = "Notes removed from HNSW/CAGRA index entirely. Always brute-force from SQLite (capped 1000). Fixes #230 staleness. HNSW is chunk-only now. CLI note commands use atomic TOML rewrite via rewrite_notes_file()."
mentions = [
    "src/search.rs",
    "src/note.rs",
    "src/cli/commands/index.rs",
]

[[note]]
sentiment = 0.5
text = "Multi-index architecture: each reference gets its own Store + HNSW. Score-based merge with weight multiplier (default 0.8). Parallel search via rayon (PR #354). Cross-store dedup via blake3 content hash."
mentions = [
    "src/reference.rs",
    "merge_results",
    "ReferenceIndex",
]

[[note]]
sentiment = -0.5
text = "Fresh-eyes review caught missing weight validation in ref add — user could pass weight >1.0 which amplifies reference scores instead of damping them. Always validate user-facing numeric inputs at entry point."
mentions = [
    "src/cli/commands/reference.rs",
    "cmd_ref_add",
]

[[note]]
sentiment = 0.5
text = "20-category audit produced 38% duplicate findings. Categories like Input Security + Data Security, Memory Management + Resource Footprint, and Algorithmic Complexity + I/O Efficiency overlap heavily. Consolidated to 14 categories / 3 batches for next run. Cuts collection time ~25% and eliminates redundancy."
mentions = [
    "docs/plans/2026-02-04-20-category-audit-design.md",
    ".claude/skills/audit/SKILL.md",
    "audit",
]

[[note]]
sentiment = -0.5
text = "CHANGELOG pollution trap: if you update CHANGELOG entries after the tag is already cut, the entry drifts from reality. Always verify with `git show vX.Y.Z:CHANGELOG.md` before a release to catch drift. v0.5.3 entry had multi-index content that wasn't in that release."
mentions = [
    "CHANGELOG.md",
    "git tag",
    "release",
]

[[note]]
sentiment = -0.5
text = "cfg(test) only applies within the library crate's unit tests. Integration tests (tests/*.rs) are separate compilation units — they see the public API without cfg(test) gating. Can't use cfg(test) to hide types only needed by integration tests."
mentions = [
    "cfg(test)",
    "tests/",
    "integration tests",
]

[[note]]
sentiment = -0.5
text = "cqs diff loads embeddings one-by-one for each matched pair via get_chunk_with_embedding. For large diffs (1000+ matched functions), this will be slow. Batch loading would help but adds complexity — defer until someone hits the perf wall."
mentions = [
    "src/diff.rs",
    "semantic_diff",
    "get_chunk_with_embedding",
]

[[note]]
sentiment = 0.5
text = "Create cqs-prefixed skills in .claude/skills/ to extend agent capabilities. Skill = SKILL.md with frontmatter (name, description, argument-hint) + usage docs. Update bootstrap's portable skills list and decide if project-local or global (~/.claude/skills/). Keep names prefixed to avoid collisions."
mentions = [
    ".claude/skills/cqs-bootstrap/SKILL.md",
    ".claude/skills/",
]

[[note]]
sentiment = 1.0
text = "Post-v0.8.0 features shipped across 3 context windows with zero regressions. Tears + MEMORY.md system worked — each window picked up exactly where the last left off. Key: commit per batch, update tears after each commit, keep MEMORY.md under 200 lines."
mentions = [
    "PROJECT_CONTINUITY.md",
    "MEMORY.md",
    "tears",
    "workflow",
]

[[note]]
sentiment = 0.5
text = "Module splitting patterns: impl Foo blocks can live in separate files (no trait needed, public API unchanged). But trait method imports (e.g. `use hnsw_rs::api::AnnT`) don't carry across submodule files — each file needs its own. Used for parser/ and hnsw/ directory refactors in v0.9.0."
mentions = [
    "src/parser/chunk.rs",
    "src/parser/calls.rs",
    "src/hnsw/build.rs",
    "src/hnsw/search.rs",
    "src/hnsw/persist.rs",
]

[[note]]
sentiment = 0.5
text = "One-hot embeddings for HNSW test stability: sin-based make_embedding(seed) produced vectors too similar in 769-dim cosine space — HNSW approximate search couldn't reliably rank the exact match. Fix: one-hot-like vectors (0.01 baseline + 1.0 spike at seed-specific dimension). Cosine similarity ~0.01 between seeds, 1.0 for same seed. Reusable pattern for any HNSW test needing well-separated embeddings."
mentions = [
    "src/hnsw/safety.rs",
    "src/hnsw/build.rs",
    "make_embedding",
    "flaky test",
]

[[note]]
sentiment = 0.5
text = "CLI trace/impact/gather tools combine search + call graph traversal to collapse 5-10 file reads into one semantic operation. Saves tokens via server-side context assembly. Design applies to any AI consumer that values efficiency."
mentions = [
    "src/cli/commands/trace.rs",
    "src/impact.rs",
    "src/gather.rs",
]

[[note]]
sentiment = -1.0
text = "Never call store.search() directly in production code — raw embedding cosine only, no RRF hybrid or keyword matching. Always use search_filtered() or search_unified_with_index(). gather() and search_across_projects() both had this bug, fixed in PR #305."
mentions = [
    "src/gather.rs",
    "src/project.rs",
    "src/store/mod.rs",
    "search_filtered",
]

[[note]]
sentiment = -0.5
text = "Bashrc non-interactive guard (case $- in *i*) blocks all exports below it for tool shells. CUDA/lib env vars must go ABOVE the guard. Session lost 30min to LD_LIBRARY_PATH not reaching cargo test."
mentions = [
    "~/.bashrc",
    "LD_LIBRARY_PATH",
    "CUDA_PATH",
    "gpu-search",
]

[[note]]
sentiment = -0.5
text = """Tree-sitter query capture names must match extract_chunk's hardcoded capture_types: "function", "struct", "class", "enum", "trait", "interface", "const". Using @constant instead of @const silently drops matches — no error, just missing chunks."""
mentions = [
    "src/parser/chunk.rs",
    "src/language/sql.rs",
    "extract_chunk",
]

[[note]]
sentiment = -0.5
text = "Git deps in Cargo.toml block cargo publish. For tree-sitter grammar forks, publish the fork to crates.io under a new name (e.g. tree-sitter-sequel-tsql) then use version dep. One-time effort per grammar fork."
mentions = [
    "Cargo.toml",
    "tree-sitter-sql",
    "cargo publish",
]

[[note]]
sentiment = 0.5
text = "Adding a new language to cqs requires: (1) tree-sitter grammar crate, (2) one-liner in define_languages! macro, (3) LanguageDef with chunk_query + call_query, (4) test fixture + parser tests, (5) match arms in eval_test.rs and model_eval.rs. The define_languages! macro (PR #307) reduced this from 13 scattered changes."
mentions = [
    "src/language/mod.rs",
    "define_languages",
    "src/language/sql.rs",
]

[[note]]
sentiment = -0.5
text = "extract_name_fallback() in chunk.rs searches for SQL keywords (PROCEDURE, FUNCTION, VIEW, TRIGGER) but lives in generic parser code. Harmless for non-SQL languages (returns None) but couples generic parsing to SQL-specific knowledge."
mentions = [
    "src/parser/chunk.rs",
    "extract_name_fallback",
]

[[note]]
sentiment = -0.5
text = '''SignatureStyle::UntilAs doesn't handle \r\n line endings. Patterns " AS ", "\nAS\n", "\nAS " won't match "\r\nAS\r\n". Git usually normalizes but raw Windows .sql files will break signature extraction.'''
mentions = [
    "src/parser/chunk.rs",
    "extract_signature",
    "SignatureStyle::UntilAs",
]

[[note]]
sentiment = 0.5
text = "PDF-to-markdown pipeline works: pymupdf4llm converts AVEVA Historian manuals cleanly. Heading hierarchy preserved (# through ######). Noise: copyright footers, page numbers, ToC dot leaders need stripping. 39 PDFs → 14MB markdown in samples/md/."
mentions = [
    "samples/md/",
    "samples/pdf/",
    "pymupdf4llm",
]

[[note]]
sentiment = -0.5
text = '''Rust regex crate doesn't support lookbehind (?<!). Had to rewrite markdown image link filter from (?<!!)\[...\] to match all links then check preceding byte. Common gotcha when porting regex from other languages.'''
mentions = ["src/parser/markdown.rs"]

[[note]]
sentiment = -0.5
text = "Merge-small-sections logic was backwards: small section absorbed the next instead of being absorbed by it. Title (4 lines) ate Section A (37 lines), producing one giant chunk. Direction matters — small merges INTO next, not extends to swallow."
mentions = ["src/parser/markdown.rs"]

[[note]]
sentiment = 0.5
text = "Adaptive heading detection works for both standard and inverted hierarchies. Heuristic: 'shallowest heading level appearing more than once, excluding title' = primary split level. Handles AVEVA docs (H2 title → H1 chapters) and standard markdown (H1 title → H2 sections) with same code."
mentions = ["src/parser/markdown.rs"]

[[note]]
sentiment = -0.5
text = "Always verify release binary version matches latest code before testing features. Previous session used debug build for markdown indexing but never rebuilt release. cqs --version catches this."
mentions = [
    "release binary",
    "cargo build --release",
]

[[note]]
sentiment = -0.5
text = "CLI-first migration: clap allow_negative_numbers=true is required for args that accept negative floats like --sentiment -0.5, otherwise clap parses -0 as an unknown flag"
mentions = [
    "src/cli/commands/notes.rs",
    "clap",
]

[[note]]
sentiment = 0.5
text = "File-based audit mode (.cqs/audit-mode.json with RFC 3339 expiry) persists state across CLI invocations. Simple alternative to in-memory state tracking."
mentions = [
    "src/audit.rs",
    ".cqs/audit-mode.json",
]

[[note]]
sentiment = -0.5
text = "cuvs Rust crate passes CI without GPU feature, but gpu-search build requires matching libcuvs conda package version"
mentions = [
    "cuvs",
    "gpu-search",
]

[[note]]
sentiment = 0.5
text = "cuDNN via conda (conda-forge) keeps libcudnn.so.9 in miniforge3/lib which is already on LD_LIBRARY_PATH — no path changes needed"
mentions = [
    "cudnn",
    "LD_LIBRARY_PATH",
]

[[note]]
sentiment = 0.5
text = "SQLite integrity check on every Store::open via PRAGMA quick_check. Catches B-tree corruption early with StoreError::Corruption. Added in PR #343 (DS12)."
mentions = [
    "src/store/mod.rs",
    "src/store/helpers.rs",
]

[[note]]
sentiment = -0.5
text = "FTS5 queries need sanitization — special chars (quotes, parens, +, -, ^, :) and reserved words (OR, AND, NOT, NEAR) cause MATCH failures. sanitize_fts_query() strips them before all FTS calls."
mentions = [
    "src/store/chunks.rs",
    "FTS5",
    "sanitize_fts_query",
]

[[note]]
sentiment = 0.5
text = "Embedder clear_session() releases ~500MB ONNX session memory for long-running processes. Session lazily re-initializes on next embed call. Use during idle periods in watch mode."
mentions = [
    "src/embedder.rs",
    "clear_session",
    "OnceCell",
]

[[note]]
sentiment = -0.5
text = '''WSL vhdx doesn't auto-shrink. Deleting files inside WSL frees space on ext4 but the vhdx on C: stays the same size. Must wsl --shutdown + diskpart compact vdisk to reclaim Windows disk space. Our vhdx is at C:\Users\user001\AppData\Local\wsl\{830cd9dc-...}\ext4.vhdx (180GB allocated, ~69GB used).'''
mentions = [
    "WSL",
    "disk-space",
]

[[note]]
sentiment = 0.5
text = "MCP removal was clean because all logic lived in library modules. The MCP layer was a pure JSON-RPC wrapper — deleting ~6200 lines required zero changes to core search/graph/impact code. Validates keeping business logic in src/*.rs with thin CLI wrappers."
mentions = [
    "src/lib.rs",
    "src/audit.rs",
    "PR #352",
]

[[note]]
sentiment = -0.5
text = "HNSW checksum file is now mandatory — missing checksum returns error, not warning. Bincode deserializes unverified bytes, so loading without checksum = trusting arbitrary data. Always regenerate with cqs index --force if checksum missing."
mentions = [
    "src/hnsw/persist.rs",
    "blake3",
]

[[note]]
sentiment = 0.5
text = "Brute-force search uses cursor batching (5000 rows, WHERE rowid > N) not fetch_all(). Peak memory O(batch) not O(total). Same pattern as EmbeddingBatchIterator in store/chunks.rs. futures crate was removed so can't use sqlx streaming."
mentions = [
    "src/search.rs",
    "brute-force",
]

[[note]]
sentiment = 0.5
text = "Pre-audit security sweep found 10 issues in code that passed 3 prior audits. Different lens (attacker mindset vs code quality) catches different bugs. Run security-focused review separately from quality audits."
mentions = [
    "audit",
    "security",
]

[[note]]
sentiment = -0.5
text = "CRLF line ending drift in WSL: Edit tool on /mnt/c/ NTFS files can silently introduce CRLF, causing full-file diffs of unchanged files. Always check git diff --stat before committing. Use git checkout -- <file> to restore."
mentions = [
    "WSL",
    "git",
]

[[note]]
sentiment = -0.5
text = "Half-open vs inclusive interval overlap: hunk [start, start+count) vs chunk [line_start, line_end]. Correct: start <= end_inclusive && exclusive_end > start_inclusive. Using >= with exclusive end is the classic off-by-one."
mentions = [
    "src/impact.rs",
    "map_hunks_to_functions",
]

[[note]]
sentiment = 0.5
text = "compute_hints accepts prefetched_caller_count to avoid duplicate get_callers_full() when caller already has the data. Pattern: pass Optional<precomputed> to helper functions that would otherwise re-query."
mentions = [
    "src/impact.rs",
    "compute_hints",
]

[[note]]
sentiment = -0.5
text = "57 stale remote branches accumulated before cleanup. Squash-merge doesn't mark branches as merged in git, so git branch -r --merged misses them. Prune after each release: git remote prune origin."
mentions = [
    "release",
    "git",
]

[[note]]
sentiment = 1.0
text = "7-feature plan executed cleanly across multiple sessions. Plan file structure (build order, per-feature sections with SQL, structs, files, tests, fresh-eyes findings) was effective. The build-order dependency chain (2→6→5→3→4→1→7) prevented integration conflicts."
mentions = [
    "plans",
    "agent-experience",
]

[[note]]
sentiment = -0.5
text = "WSL inotify over 9P delivers duplicate/delayed events for the same file change, causing watch mode to reindex in a loop. Fix: track last-indexed mtime per file, skip events where mtime hasn't changed."
mentions = [
    "src/cli/watch.rs",
    "WSL",
    "inotify",
]

[[note]]
sentiment = -0.5
text = "Scout note matching: m.ends_with(f) was wrong direction — matched when mention contains file path as suffix. Only f.ends_with(m) with path-component boundary check is correct. General lesson: string suffix matching on paths needs boundary guards."
mentions = [
    "src/scout.rs",
    "note_mention_matches_file",
]

[[note]]
sentiment = 0.0
text = "cqs plan R&D: data layer works (scout+callers+impact+test-map finds relevant code and blast radius). Missing: reasoning layer (task-type templates like 'add flag' = Cli+Config+wiring+gating). Abstract queries score poorly; name-based lookups work. Better as a skill than a command."
mentions = [
    "src/scout.rs",
    "cqs plan",
]
