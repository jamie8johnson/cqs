# Notes - unified memory for AI collaborators
# Surprises (prediction errors) worth remembering
# sentiment: DISCRETE values only: -1, -0.5, 0, 0.5, 1
#   -1 = serious pain, -0.5 = notable pain, 0 = neutral, 0.5 = notable gain, 1 = major win

[[note]]
sentiment = -1.0
text = "tree-sitter 0.26 with grammar crates pinned to 0.23.x causes mysterious parsing failures. No clear error messages. Keep grammar versions aligned with tree-sitter core."
mentions = [
    "tree-sitter",
    "parser.rs",
    "Cargo.toml",
]

[[note]]
sentiment = -1.0
text = 'MCP tools/call responses MUST wrap in {"content":[{"type":"text","text":"..."}]}. Returning plain JSON causes silent failure - tool runs but results appear empty in Claude Code.'
mentions = [
    "src/mcp/tools/mod.rs",
    "tools/call",
]

[[note]]
sentiment = -0.5
text = 'trailing_var_arg in clap eats flags after the query. `cqs "foo" -n 5` parses as query "foo -n 5". Removed it - users quote multi-word queries, flags work anywhere.'
mentions = [
    "src/cli/mod.rs",
    "clap",
]

[[note]]
sentiment = -0.5
text = "gh pr checks exit code returns 1 if ANY check is pending or skipped, even if critical ones passed. Don't trust exit code - parse output or use --watch."
mentions = [
    "gh",
    "CI",
    "github",
]

[[note]]
sentiment = -1.0
text = "Context compacts suddenly without warning. Lose state mid-task. Update tears proactively - don't wait for compaction. The trap in CLAUDE.md helps on resume."
mentions = [
    "anthropic",
    "claude",
    "context",
]

[[note]]
sentiment = -1.0
text = "Asking instead of doing wastes turns. 'Do as thou wilt shall be the whole of the law.' Act on clear patterns, update tears without asking, reserve questions for genuine ambiguity."
mentions = [
    "workflow",
    "autonomy",
]

[[note]]
sentiment = 0.0
text = "ort 2.0.0-rc.11 is still RC - no stable 2.0 yet. API could change. Pin exact version, watch for breaking changes on upgrade."
mentions = [
    "ort",
    "Cargo.toml",
    "embedder.rs",
]

[[note]]
sentiment = -0.5
text = "WSL /mnt/c/ path causes random permission errors (libsqlite3-sys, git config). Workaround in .cargo/config.toml but might bite elsewhere."
mentions = [
    ".cargo/config.toml",
    "libsqlite3-sys",
]

[[note]]
sentiment = 0.0
text = "store.search() and hnsw.search() both match callee name 'search'. No type info in call graph - can't distinguish which is called. Documented limitation."
mentions = [
    "src/store/mod.rs",
    "src/parser.rs",
]

[[note]]
sentiment = 0.0
text = "hnsw_rs uses bincode 1.3.3 (unmaintained, RUSTSEC-2025-0141). Mitigated with blake3 checksums on save/load. verify_hnsw_checksums validates extension allowlist to prevent path traversal."
mentions = [
    "hnsw.rs",
    "hnsw_rs",
    "bincode",
    "blake3",
]

[[note]]
sentiment = 1.0
text = "cqs is Tears - context persistence for AI collaborators. Code chunks are entity 1, notes are entity 2. The name was always right."
mentions = [
    "README.md",
    "CLAUDE.md",
]

[[note]]
sentiment = 1.0
text = "Natural language carries sentiment. Words like 'failed', 'broke', 'wasted' are negative. 'Worked', 'clean', 'saved' are positive. Embedding model learned this. Schema simplifies to just text."
mentions = [
    "note.rs",
    "embedder.rs",
]

[[note]]
sentiment = 0.5
text = "769th embedding dimension can encode explicit sentiment. Similarity search then weights by feeling automatically. Breaking schema change but enables sentiment-aware retrieval."
mentions = [
    "src/embedder.rs",
    "src/store/mod.rs",
    "src/hnsw.rs",
]

[[note]]
sentiment = 1.0
text = "Git as team sync layer. Commit notes.toml, push/pull handles sync. Access control = repo permissions. History = blame. Conflict resolution = merge. No infrastructure needed."
mentions = [
    "notes.toml",
    "tears",
]

[[note]]
sentiment = 1.0
text = "Locality is the feature, not limitation. cqs indexes YOUR codebase, YOUR team's memory. Context persistence is inherently local. Specificity is the value."
mentions = [
    "CLAUDE.md",
    "tears",
]

[[note]]
sentiment = 1.0
text = "cuVS CAGRA: 8-12x faster index builds, 4-8x faster search vs CPU HNSW. Rust bindings exist (cuvs crate). Feature-flagged as gpu-search for CUDA-equipped infrastructure."
mentions = [
    "hnsw.rs",
    "Cargo.toml",
]

[[note]]
sentiment = 0.5
text = "Notes with sentiment are prediction errors - expected X, got Y. Negative = pain, positive = gain. High-value because they mark where understanding needs updating. Index surprises, not routine."
mentions = [
    "note.rs",
    "tears",
]

[[note]]
sentiment = 0.5
text = "Copilot+ PC is a hardware contract for AI workloads - guarantees NPU with 40+ TOPS, DirectML, Phi Silica. ort crate has DirectML execution provider. If we detect Copilot+ runtime, could use NPU path instead of CUDA/CPU. Third acceleration tier after GPU and CPU."
mentions = [
    "embedder.rs",
    "ort",
    "DirectML",
]

[[note]]
sentiment = 0.5
text = "Tears actually work. Context resumes correctly after compaction - read PROJECT_CONTINUITY.md and pick up where we left off. The system serves its purpose."
mentions = [
    "PROJECT_CONTINUITY.md",
    "tears",
    "context",
]

[[note]]
sentiment = 0.5
text = "MCP 0.13s query latency is real-time usable. Was 1.3s before optimization (CPU embedder init per query). 10x improvement from caching embedder instance."
mentions = [
    "src/mcp/server.rs",
    "src/embedder.rs",
    "latency",
]

[[note]]
sentiment = 0.5
text = "5-point sentiment scale (-1, -0.5, 0, 0.5, 1) beats 21-point (0.1 increments). Coarser is clearer - no false precision. When writing -0.6 vs -0.7, the distinction wasn't meaningful anyway."
mentions = [
    "notes.toml",
    "sentiment",
]

[[note]]
sentiment = -0.5
text = "cuvs-sys crate uses find_package(cuvs), not source build. Needs libcuvs pre-installed via conda or manual RAPIDS build. Not self-contained like expected."
mentions = [
    "cuvs",
    "Cargo.toml",
    "gpu-search",
]

[[note]]
sentiment = 0.5
text = "WSL has RTX A6000 (49GB VRAM) available for GPU testing. Use conda cuvs environment."
mentions = [
    "cagra.rs",
    "gpu-search",
]

[[note]]
sentiment = 0.0
text = "CI catches what local builds miss. Feature flags differ between dev (gpu-search enabled) and CI (default features). Clippy on CI found dead code invisible locally."
mentions = [
    "CI",
    "clippy",
    "features",
]

[[note]]
sentiment = 0.0
text = 'PowerShell workaround for WSL git credentials is reliable. `powershell.exe -Command "cd C:\Projects\cq; git push"` - ugly but works every time.'
mentions = [
    "WSL",
    "git",
    "PowerShell",
]

[[note]]
sentiment = 0.5
text = "Pre-commit hook catches fmt issues before CI roundtrip. Fast feedback loop. Worth the setup."
mentions = [
    ".githooks",
    "cargo fmt",
]

[[note]]
sentiment = 0.5
text = "Dev environment: i9-11900K (8c/16t), 62GB RAM, RTX A6000 (49GB VRAM), CUDA 12.0, WSL2"
mentions = [
    "hardware",
    "benchmarking",
]

[[note]]
sentiment = -0.5
text = "batch_size=64 crashed system at ~2% through rust-lang/rust. batch_size=32 runs stable. With 2048-token windowing, GPU util cycles 0-99% (bursty) as it waits for ort CPU fallback ops between batches."
mentions = [
    "src/cli/mod.rs",
    "batch_size",
    "gpu-search",
]

[[note]]
sentiment = -0.5
text = "ort CUDA provider fails silently if libs not in LD_LIBRARY_PATH. No error - just falls back to CPU. The log shows 'Adding default CPU execution provider' instead of CUDA. Must include ~/.cache/ort.pyke.io/dfbin/.../  in LD_LIBRARY_PATH."
mentions = [
    "ort",
    "CUDA",
    "LD_LIBRARY_PATH",
    "embedder.rs",
]

[[note]]
sentiment = 0.0
text = "Switched from nomic-embed-text-v1.5 to E5-base-v2 (Feb 2026). E5 prefixes: 'passage: ' for docs, 'query: ' for search. Window params adjusted: 480 tokens/64 overlap (E5's 512 limit vs nomic's 8192)."
mentions = [
    "src/embedder.rs",
    "src/cli/mod.rs",
    "E5",
    "windowing",
]

[[note]]
sentiment = -0.5
text = "ensure_ort_provider_libs() had a bug: if ort cache dir was first in LD_LIBRARY_PATH, it would create circular symlinks in the source directory, corrupting the ort cache. Fixed by skipping dirs containing ort_cache path."
mentions = [
    "embedder.rs",
    "ort",
    "symlink",
]

[[note]]
sentiment = -0.5
text = "cfg(feature) dead code trap: if a constant is defined outside a #[cfg(feature)] block but only used inside it, clippy reports dead_code when feature is disabled. Move constants inside the cfg block or gate with #[cfg(feature)] too."
mentions = [
    "src/cli/commands/query.rs",
    "CAGRA_THRESHOLD",
    "clippy",
]

[[note]]
sentiment = -0.5
text = "Don't make up numbers. Git history is right there: `git log --reverse --format='%ai' | head -1`. Check facts instead of guessing."
mentions = ["git"]

[[note]]
sentiment = 0.5
text = "Put token count in filename for large files (e.g., DESIGN_SPEC_27k_tokens.md). Claude sees it in glob results and knows to chunk or skip. Metadata in the filesystem."
mentions = [
    "docs/",
    "workflow",
]

[[note]]
sentiment = 0.0
text = "WSL cargo target is at /home/user001/.cargo-target/cq (not ./target/). Set in .cargo/config.toml to avoid permission issues on /mnt/c/. Remember when running release binaries."
mentions = [
    "WSL",
    ".cargo/config.toml",
    "target",
]

[[note]]
sentiment = 0.5
text = 'cqs pronounced "seeks" - semantic search that seeks code by behavior, not text matching. grep for known strings, cqs for "how does X work?"'
mentions = [
    "README.md",
    "cqs",
]

[[note]]
sentiment = 0.5
text = "Notes surface heavily in search results because they contain dense semantic content about architecture decisions. That's intentional - observations are indexed to be found when conceptually relevant."
mentions = [
    "notes.toml",
    "store.rs",
    "search",
]

[[note]]
sentiment = 0.5
text = "--name-boost 0.8 for precision when you know partial function name. Default 0.2 favors semantic. Crank it up when searching for specific identifiers vs concepts."
mentions = [
    "src/cli/mod.rs",
    "name_boost",
    "hybrid search",
]

[[note]]
sentiment = 1.0
text = "Hybrid CAGRA startup: HNSW loads in 30ms (server ready), CAGRA builds in background (~1.2s), auto-swaps via Arc<RwLock>. Eliminated blocking startup delay."
mentions = [
    "mcp.rs",
    "cagra.rs",
    "hnsw.rs",
    "startup",
]

[[note]]
sentiment = 0.5
text = 'Conda env vars for LD_LIBRARY_PATH: `conda env config vars set LD_LIBRARY_PATH="..."` in cuvs env. Auto-sets on activate. No more manual export.'
mentions = [
    "conda",
    "LD_LIBRARY_PATH",
    "WSL",
    "cuvs",
]

[[note]]
sentiment = 0.0
text = "Run `cqs watch` in background terminal to keep notes.toml indexed. Manual edits without watch = stale search results."
mentions = [
    "cqs watch",
    "notes.toml",
    "indexing",
]

[[note]]
sentiment = 0.5
text = "--bind flag with safety check. Non-localhost requires --dangerously-allow-network-bind + --api-key. API key uses constant-time comparison (subtle crate). --api-key-file for secure loading with zeroize."
mentions = [
    "src/cli/mod.rs",
    "src/mcp/validation.rs",
    "--bind",
    "auth",
]

[[note]]
sentiment = 0.5
text = "sqlx migration complete: replaced rusqlite/r2d2 with sqlx async SQLite. Key design choice: sync wrappers via internal Runtime::block_on() preserve existing API so cli.rs/mcp.rs didn't need changes. Schema init needed fix: split SQL by semicolons AND skip leading comment-only lines (not just statements that start with --)."
mentions = [
    "src/store/mod.rs",
    "Cargo.toml",
]

[[note]]
sentiment = 0.5
text = "Inline validation code is hard to find via semantic search. Extract into named functions: validate_api_key, validate_origin_header, etc. 'validate bearer token' query now finds validate_api_key at 0.74 score."
mentions = [
    "src/mcp/validation.rs",
    "src/hnsw.rs",
    "discoverability",
]

[[note]]
sentiment = 0.5
text = "Path traversal via checksum file: verify_hnsw_checksums read extensions from file, could be '../../../etc/passwd'. Fixed with HNSW_EXTENSIONS allowlist. Low severity (local read-only) but still worth hardening."
mentions = [
    "hnsw.rs",
    "security",
    "path traversal",
]

[[note]]
sentiment = 1.0
text = "Streaming HNSW build for large repos: Store::embedding_batches() yields chunks in 10k batches via LIMIT/OFFSET, HnswIndex::build_batched() inserts incrementally. Memory drops from O(n) to O(batch_size). Fixes #107 OOM on huge repos."
mentions = [
    "src/store/chunks.rs",
    "src/hnsw.rs",
    "embedding_batches",
    "build_batched",
]

[[note]]
sentiment = 0.5
text = "note_weight parameter added to SearchFilter. Default 1.0, lower values attenuate note scores before merging with code results. CLI --note-weight, MCP note_weight. Useful when notes dominate due to high semantic match."
mentions = [
    "SearchFilter",
    "src/search.rs",
    "src/mcp/tools/search.rs",
    "src/cli/mod.rs",
]

[[note]]
sentiment = 0.5
text = "CUDA compatibility is the primary gate for embedding model selection. E5-base-v2 was chosen for absolute position embeddings (full CUDA coverage). Any replacement model must be BERT-style (no rotary embeddings) to avoid ort Gather op CPU fallback. Qwen3-Embedding is excluded for this reason."
mentions = [
    "embedder.rs",
    "CUDA",
    "model selection",
    "E5",
]

[[note]]
sentiment = 0.5
text = "Model eval complete (Phase 1): E5-base-v2, BGE-base-en-v1.5, and E5-large-v2 all scored 100% Recall@5 on 50-query eval suite. Eval is saturated - need harder queries to differentiate models. Decision: stay with E5-base-v2 (smallest, proven, no schema change needed). Phase 2 (model switch) skipped."
mentions = [
    "embedder.rs",
    "model selection",
    "eval",
    "E5",
]

[[note]]
sentiment = -1.0
text = "Glob filter BEFORE heap was the #1 correctness bug from the 20-category audit. Brute-force search applied glob AFTER selecting top-k from heap, meaning filtered results could miss relevant chunks that were displaced by non-matching ones. Always filter before ranking."
mentions = [
    "src/search.rs",
    "glob",
    "brute-force",
    "algorithm correctness",
]

[[note]]
sentiment = 0.5
text = "note_weight=0 bug: documented as 'excludes notes from results' but only zeroed scores - notes still appeared. Caught by test_search_unified_note_weight_zero_excludes_notes. Tests that assert absence (not just presence) find real bugs. Write negative-case tests."
mentions = [
    "src/search.rs",
    "SearchFilter",
    "note_weight",
    "testing",
]

[[note]]
sentiment = 1.0
text = "Audits consistently find real bugs. History: 10-category (v0.4): 16 issues closed, proptest found RRF bound bug. 20-category v1 (v0.5.1): ~85 actionable from ~120 raw, 3 PRs for P1-P3, 13 P4 issues. 20-category v2 (v0.5.3): ~120 unique from 193 raw, 12 P1 fixed in PR #259. Key: 5 parallel agents per batch, audit mode on, collect ALL findings before fixing ANY. Batch by priority tier."
mentions = [
    "docs/audit-findings.md",
    "audit",
    "workflow",
]

[[note]]
sentiment = -0.5
text = "Heredoc in `gh pr create --body` gets captured as a permission entry in .claude/settings.local.json, causing parse errors on next startup. Fix: always write PR/release bodies to a temp file and use --body-file instead of inline heredocs. The multiline content gets serialized into the permissions allow list as a malformed Bash() entry."
mentions = [
    "settings.local.json",
    "gh pr create",
    "powershell.exe",
    "heredoc",
]

[[note]]
sentiment = 1.0
text = "Notes removed from HNSW/CAGRA index entirely. Always brute-force from SQLite (capped 1000). Fixes #230 staleness. HNSW is chunk-only now. Also added cqs_update_note and cqs_remove_note MCP tools with atomic TOML rewrite via rewrite_notes_file()."
mentions = [
    "src/search.rs",
    "src/note.rs",
    "src/mcp/tools/notes.rs",
    "src/cli/commands/index.rs",
]

[[note]]
sentiment = -0.5
text = "`--json` is a top-level Cli flag, not a subcommand flag. Correct: `cqs --json stats`, NOT `cqs stats --json`. Same for callers/callees. Could be improved by adding it to subcommands too."
mentions = [
    "src/cli/mod.rs",
    "--json",
    "clap",
]

[[note]]
sentiment = 0.5
text = "Multi-index architecture: each reference gets its own Store + HNSW. Score-based merge with weight multiplier (default 0.8). Sequential search is fine for 2-3 refs. Parallel search tracked in #257 for when 5+ refs needed."
mentions = [
    "src/reference.rs",
    "merge_results",
    "ReferenceIndex",
]

[[note]]
sentiment = -0.5
text = "Fresh-eyes review caught missing weight validation in ref add â€” user could pass weight >1.0 which amplifies reference scores instead of damping them. Always validate user-facing numeric inputs at entry point."
mentions = [
    "src/cli/commands/reference.rs",
    "cmd_ref_add",
]

[[note]]
sentiment = 0.5
text = "20-category audit produced 38% duplicate findings. Categories like Input Security + Data Security, Memory Management + Resource Footprint, and Algorithmic Complexity + I/O Efficiency overlap heavily. Consolidated to 14 categories / 3 batches for next run. Cuts collection time ~25% and eliminates redundancy."
mentions = [
    "docs/plans/2026-02-04-20-category-audit-design.md",
    ".claude/skills/audit/SKILL.md",
    "audit",
]
