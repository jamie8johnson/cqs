# Notes - unified memory for AI collaborators
# Surprises (prediction errors) worth remembering
# sentiment: DISCRETE values only: -1, -0.5, 0, 0.5, 1
#   -1 = serious pain, -0.5 = notable pain, 0 = neutral, 0.5 = notable gain, 1 = major win

[[note]]
sentiment = -0.5
text = 'trailing_var_arg in clap eats flags after the query. `cqs "foo" -n 5` parses as query "foo -n 5". Removed it - users quote multi-word queries, flags work anywhere.'
mentions = [
    "src/cli/mod.rs",
    "clap",
]

[[note]]
sentiment = -0.5
text = "gh pr checks exit code returns 1 if ANY check is pending or skipped, even if critical ones passed. Don't trust exit code - parse output or use --watch."
mentions = [
    "gh",
    "CI",
    "github",
]

[[note]]
sentiment = -0.5
text = "WSL /mnt/c/ path causes random permission errors (libsqlite3-sys, git config). Workaround in .cargo/config.toml but might bite elsewhere."
mentions = [
    ".cargo/config.toml",
    "libsqlite3-sys",
]

[[note]]
sentiment = 0.5
text = "769th embedding dimension can encode explicit sentiment. Similarity search then weights by feeling automatically. Breaking schema change but enables sentiment-aware retrieval."
mentions = [
    "src/embedder.rs",
    "src/store/mod.rs",
    "src/hnsw/mod.rs",
]

[[note]]
sentiment = 1.0
text = "Git as team sync layer. Commit notes.toml, push/pull handles sync. Access control = repo permissions. History = blame. Conflict resolution = merge. No infrastructure needed."
mentions = [
    "notes.toml",
    "tears",
]

[[note]]
sentiment = 1.0
text = "cuVS CAGRA: 8-12x faster index builds, 4-8x faster search vs CPU HNSW. Rust bindings exist (cuvs crate). Feature-flagged as gpu-index for CUDA-equipped infrastructure."
mentions = [
    "src/hnsw/mod.rs",
    "Cargo.toml",
]

[[note]]
sentiment = 0.5
text = "Copilot+ PC is a hardware contract for AI workloads - guarantees NPU with 40+ TOPS, DirectML, Phi Silica. ort crate has DirectML execution provider. If we detect Copilot+ runtime, could use NPU path instead of CUDA/CPU. Third acceleration tier after GPU and CPU."
mentions = [
    "embedder.rs",
    "ort",
    "DirectML",
]

[[note]]
sentiment = 0.5
text = "5-point sentiment scale (-1, -0.5, 0, 0.5, 1) beats 21-point (0.1 increments). Coarser is clearer - no false precision. When writing -0.6 vs -0.7, the distinction wasn't meaningful anyway."
mentions = [
    "notes.toml",
    "sentiment",
]

[[note]]
sentiment = -0.5
text = "cuvs-sys crate uses find_package(cuvs), not source build. Needs libcuvs pre-installed via conda or manual RAPIDS build. Not self-contained like expected."
mentions = [
    "cuvs",
    "Cargo.toml",
    "gpu-index",
]

[[note]]
sentiment = 0.0
text = "CI catches what local builds miss. Feature flags differ between dev (gpu-index enabled) and CI (default features). Clippy on CI found dead code invisible locally."
mentions = [
    "CI",
    "clippy",
    "features",
]

[[note]]
sentiment = 0.5
text = "Pre-commit hook catches fmt issues before CI roundtrip. Fast feedback loop. Worth the setup."
mentions = [
    ".githooks",
    "cargo fmt",
]

[[note]]
sentiment = -0.5
text = "batch_size=64 crashed system at ~2% through rust-lang/rust. batch_size=32 runs stable. With 2048-token windowing, GPU util cycles 0-99% (bursty) as it waits for ort CPU fallback ops between batches."
mentions = [
    "src/cli/mod.rs",
    "batch_size",
    "gpu-index",
]

[[note]]
sentiment = -0.5
text = "ort CUDA provider fails silently if libs not in LD_LIBRARY_PATH. No error - just falls back to CPU. The log shows 'Adding default CPU execution provider' instead of CUDA. Must include ~/.cache/ort.pyke.io/dfbin/.../  in LD_LIBRARY_PATH."
mentions = [
    "ort",
    "CUDA",
    "LD_LIBRARY_PATH",
    "embedder.rs",
]

[[note]]
sentiment = -0.5
text = "Don't make up numbers. Git history is right there: `git log --reverse --format='%ai' | head -1`. Check facts instead of guessing."
mentions = ["git"]

[[note]]
sentiment = 0.5
text = "Put token count in filename for large files (e.g., DESIGN_SPEC_27k_tokens.md). Claude sees it in glob results and knows to chunk or skip. Metadata in the filesystem."
mentions = [
    "docs/",
    "workflow",
]

[[note]]
sentiment = 0.5
text = "Notes surface heavily in search results because they contain dense semantic content about architecture decisions. That's intentional - observations are indexed to be found when conceptually relevant."
mentions = [
    "notes.toml",
    "src/store/mod.rs",
    "search",
]

[[note]]
sentiment = 0.5
text = "--name-boost 0.8 for precision when you know partial function name. Default 0.2 favors semantic. Crank it up when searching for specific identifiers vs concepts."
mentions = [
    "src/cli/mod.rs",
    "name_boost",
    "hybrid search",
]

[[note]]
sentiment = 1.0
text = "Hybrid CAGRA startup: HNSW loads in 30ms, CAGRA builds in background (~1.2s), auto-swaps via Arc<RwLock>. Non-blocking startup pattern for GPU index builds."
mentions = [
    "src/cagra.rs",
    "src/hnsw/mod.rs",
    "startup",
]

[[note]]
sentiment = 1.0
text = "Streaming HNSW build for large repos: Store::embedding_batches() yields chunks in 10k batches via cursor pagination (WHERE rowid > N), HnswIndex::build_batched() inserts incrementally. Memory drops from O(n) to O(batch_size). Fixes #107 OOM on huge repos."
mentions = [
    "src/store/chunks.rs",
    "src/hnsw/build.rs",
    "embedding_batches",
    "build_batched",
]

[[note]]
sentiment = 0.5
text = "note_weight parameter added to SearchFilter. Default 1.0, lower values attenuate note scores before merging with code results. CLI --note-weight flag. Useful when notes dominate due to high semantic match."
mentions = [
    "SearchFilter",
    "src/search.rs",
    "src/cli/mod.rs",
]

[[note]]
sentiment = 1.0
text = "Embedding model: E5-base-v2 confirmed as best choice. Hard eval (55 confusable queries across 5 languages): E5 90.9% Recall@1, 0.941 MRR vs jina-v2-base-code 80.0% R@1, 0.863 MRR. General-purpose model beats code-specific because NL template transforms code into natural language. BERT-style required for CUDA (no rotary embeddings)."
mentions = [
    "src/embedder.rs",
    "CUDA",
    "model selection",
    "E5",
]

[[note]]
sentiment = -1.0
text = "Glob filter BEFORE heap was the #1 correctness bug from the 20-category audit. Brute-force search applied glob AFTER selecting top-k from heap, meaning filtered results could miss relevant chunks that were displaced by non-matching ones. Always filter before ranking."
mentions = [
    "src/search.rs",
    "glob",
    "brute-force",
    "algorithm correctness",
]

[[note]]
sentiment = 0.5
text = "note_weight=0 bug: documented as 'excludes notes from results' but only zeroed scores - notes still appeared. Caught by test_search_unified_note_weight_zero_excludes_notes. Tests that assert absence (not just presence) find real bugs. Write negative-case tests."
mentions = [
    "src/search.rs",
    "SearchFilter",
    "note_weight",
    "testing",
]

[[note]]
sentiment = 1.0
text = "Audits consistently find real bugs. History: 10-category (v0.4): 16 issues closed, proptest found RRF bound bug. 20-category v1 (v0.5.1): ~85 actionable from ~120 raw, 3 PRs for P1-P3, 13 P4 issues. 20-category v2 (v0.6.0): ~120 unique from 193 raw, 28 fixes across P1-P3 (PRs #259, #261, #262, #263), 7 issues for remaining items. Key: 5 parallel agents per batch, audit mode on, collect ALL findings before fixing ANY. Batch by priority tier."
mentions = [
    "docs/audit-findings.md",
    "audit",
    "workflow",
]

[[note]]
sentiment = -0.5
text = "Heredoc in `gh pr create --body` gets captured as a permission entry in .claude/settings.local.json, causing parse errors on next startup. Fix: always write PR/release bodies to a temp file and use --body-file instead of inline heredocs. The multiline content gets serialized into the permissions allow list as a malformed Bash() entry."
mentions = [
    "settings.local.json",
    "gh pr create",
    "powershell.exe",
    "heredoc",
]

[[note]]
sentiment = 1.0
text = "Notes removed from HNSW/CAGRA index entirely. Always brute-force from SQLite (capped 1000). Fixes #230 staleness. HNSW is chunk-only now. CLI note commands use atomic TOML rewrite via rewrite_notes_file()."
mentions = [
    "src/search.rs",
    "src/note.rs",
    "src/cli/commands/index.rs",
]

[[note]]
sentiment = 0.5
text = "Multi-index architecture: each reference gets its own Store + HNSW. Score-based merge with weight multiplier (default 0.8). Parallel search via rayon (PR #354). Cross-store dedup via blake3 content hash."
mentions = [
    "src/reference.rs",
    "merge_results",
    "ReferenceIndex",
]

[[note]]
sentiment = -0.5
text = "Fresh-eyes review caught missing weight validation in ref add — user could pass weight >1.0 which amplifies reference scores instead of damping them. Always validate user-facing numeric inputs at entry point."
mentions = [
    "src/cli/commands/reference.rs",
    "cmd_ref_add",
]

[[note]]
sentiment = 0.5
text = "20-category audit produced 38% duplicate findings. Categories like Input Security + Data Security, Memory Management + Resource Footprint, and Algorithmic Complexity + I/O Efficiency overlap heavily. Consolidated to 14 categories / 3 batches for next run. Cuts collection time ~25% and eliminates redundancy."
mentions = [
    "docs/plans/2026-02-04-20-category-audit-design.md",
    ".claude/skills/audit/SKILL.md",
    "audit",
]

[[note]]
sentiment = -0.5
text = "CHANGELOG pollution trap: if you update CHANGELOG entries after the tag is already cut, the entry drifts from reality. Always verify with `git show vX.Y.Z:CHANGELOG.md` before a release to catch drift. v0.5.3 entry had multi-index content that wasn't in that release."
mentions = [
    "CHANGELOG.md",
    "git tag",
    "release",
]

[[note]]
sentiment = -0.5
text = "cfg(test) only applies within the library crate's unit tests. Integration tests (tests/*.rs) are separate compilation units — they see the public API without cfg(test) gating. Can't use cfg(test) to hide types only needed by integration tests."
mentions = [
    "cfg(test)",
    "tests/",
    "integration tests",
]

[[note]]
sentiment = -0.5
text = "cqs diff loads embeddings one-by-one for each matched pair via get_chunk_with_embedding. For large diffs (1000+ matched functions), this will be slow. Batch loading would help but adds complexity — defer until someone hits the perf wall."
mentions = [
    "src/diff.rs",
    "semantic_diff",
    "get_chunk_with_embedding",
]

[[note]]
sentiment = 0.5
text = "Create cqs-prefixed skills in .claude/skills/ to extend agent capabilities. Skill = SKILL.md with frontmatter (name, description, argument-hint) + usage docs. Update bootstrap's portable skills list and decide if project-local or global (~/.claude/skills/). Keep names prefixed to avoid collisions."
mentions = [
    ".claude/skills/cqs-bootstrap/SKILL.md",
    ".claude/skills/",
]

[[note]]
sentiment = 1.0
text = "Post-v0.8.0 features shipped across 3 context windows with zero regressions. Tears + MEMORY.md system worked — each window picked up exactly where the last left off. Key: commit per batch, update tears after each commit, keep MEMORY.md under 200 lines."
mentions = [
    "PROJECT_CONTINUITY.md",
    "MEMORY.md",
    "tears",
    "workflow",
]

[[note]]
sentiment = 0.5
text = "Module splitting patterns: impl Foo blocks can live in separate files (no trait needed, public API unchanged). But trait method imports (e.g. `use hnsw_rs::api::AnnT`) don't carry across submodule files — each file needs its own. Used for parser/ and hnsw/ directory refactors in v0.9.0."
mentions = [
    "src/parser/chunk.rs",
    "src/parser/calls.rs",
    "src/hnsw/build.rs",
    "src/hnsw/search.rs",
    "src/hnsw/persist.rs",
]

[[note]]
sentiment = 0.5
text = "One-hot embeddings for HNSW test stability: sin-based make_embedding(seed) produced vectors too similar in 769-dim cosine space — HNSW approximate search couldn't reliably rank the exact match. Fix: one-hot-like vectors (0.01 baseline + 1.0 spike at seed-specific dimension). Cosine similarity ~0.01 between seeds, 1.0 for same seed. Reusable pattern for any HNSW test needing well-separated embeddings."
mentions = [
    "src/hnsw/safety.rs",
    "src/hnsw/build.rs",
    "make_embedding",
    "flaky test",
]

[[note]]
sentiment = 0.5
text = "CLI trace/impact/gather tools combine search + call graph traversal to collapse 5-10 file reads into one semantic operation. Saves tokens via server-side context assembly. Design applies to any AI consumer that values efficiency."
mentions = [
    "src/cli/commands/trace.rs",
    "src/impact/mod.rs",
    "src/gather.rs",
]

[[note]]
sentiment = -1.0
text = "Never call search_embedding_only() directly in production code — raw embedding cosine only, no RRF hybrid or keyword matching. Method was originally store.search(), renamed in PR #430 to make misuse obvious. Always use search_filtered() or search_unified_with_index(). gather() and search_across_projects() both had this bug, fixed in PR #305."
mentions = [
    "src/gather.rs",
    "src/project.rs",
    "src/store/mod.rs",
    "search_filtered",
]

[[note]]
sentiment = -0.5
text = "Bashrc non-interactive guard (case $- in *i*) blocks all exports below it for tool shells. CUDA/lib env vars must go ABOVE the guard. Session lost 30min to LD_LIBRARY_PATH not reaching cargo test."
mentions = [
    "~/.bashrc",
    "LD_LIBRARY_PATH",
    "CUDA_PATH",
    "gpu-index",
]

[[note]]
sentiment = -0.5
text = """Tree-sitter query capture names must match extract_chunk's hardcoded capture_types: "function", "struct", "class", "enum", "trait", "interface", "const". Using @constant instead of @const silently drops matches — no error, just missing chunks."""
mentions = [
    "src/parser/chunk.rs",
    "src/language/sql.rs",
    "extract_chunk",
]

[[note]]
sentiment = -0.5
text = "Git deps in Cargo.toml block cargo publish. For tree-sitter grammar forks, publish the fork to crates.io under a new name (e.g. tree-sitter-sequel-tsql) then use version dep. One-time effort per grammar fork."
mentions = [
    "Cargo.toml",
    "tree-sitter-sql",
    "cargo publish",
]

[[note]]
sentiment = -0.5
text = "extract_name_fallback() in chunk.rs searches for SQL keywords (PROCEDURE, FUNCTION, VIEW, TRIGGER) but lives in generic parser code. Harmless for non-SQL languages (returns None) but couples generic parsing to SQL-specific knowledge."
mentions = [
    "src/parser/chunk.rs",
    "extract_name_fallback",
]

[[note]]
sentiment = -0.5
text = '''SignatureStyle::UntilAs doesn't handle \r\n line endings. Patterns " AS ", "\nAS\n", "\nAS " won't match "\r\nAS\r\n". Git usually normalizes but raw Windows .sql files will break signature extraction.'''
mentions = [
    "src/parser/chunk.rs",
    "extract_signature",
    "SignatureStyle::UntilAs",
]

[[note]]
sentiment = 0.5
text = "PDF-to-markdown pipeline works: pymupdf4llm converts AVEVA Historian manuals cleanly. Heading hierarchy preserved (# through ######). Noise: copyright footers, page numbers, ToC dot leaders need stripping. 39 PDFs → 14MB markdown in samples/md/."
mentions = ["pymupdf4llm"]

[[note]]
sentiment = -0.5
text = '''Rust regex crate doesn't support lookbehind (?<!). Had to rewrite markdown image link filter from (?<!!)\[...\] to match all links then check preceding byte. Common gotcha when porting regex from other languages.'''
mentions = ["src/parser/markdown.rs"]

[[note]]
sentiment = -0.5
text = "Merge-small-sections logic was backwards: small section absorbed the next instead of being absorbed by it. Title (4 lines) ate Section A (37 lines), producing one giant chunk. Direction matters — small merges INTO next, not extends to swallow."
mentions = ["src/parser/markdown.rs"]

[[note]]
sentiment = 0.5
text = "Adaptive heading detection works for both standard and inverted hierarchies. Heuristic: 'shallowest heading level appearing more than once, excluding title' = primary split level. Handles AVEVA docs (H2 title → H1 chapters) and standard markdown (H1 title → H2 sections) with same code."
mentions = ["src/parser/markdown.rs"]

[[note]]
sentiment = -0.5
text = "Always verify release binary version matches latest code before testing features. Previous session used debug build for markdown indexing but never rebuilt release. cqs --version catches this."
mentions = [
    "release binary",
    "cargo build --release",
]

[[note]]
sentiment = -0.5
text = "CLI-first migration: clap allow_negative_numbers=true is required for args that accept negative floats like --sentiment -0.5, otherwise clap parses -0 as an unknown flag"
mentions = [
    "src/cli/commands/notes.rs",
    "clap",
]

[[note]]
sentiment = 0.5
text = "File-based audit mode (.cqs/audit-mode.json with RFC 3339 expiry) persists state across CLI invocations. Simple alternative to in-memory state tracking."
mentions = [
    "src/audit.rs",
    ".cqs/audit-mode.json",
]

[[note]]
sentiment = 0.5
text = "SQLite integrity check on every Store::open via PRAGMA quick_check. Catches B-tree corruption early with StoreError::Corruption. Added in PR #343 (DS12)."
mentions = [
    "src/store/mod.rs",
    "src/store/helpers.rs",
]

[[note]]
sentiment = -0.5
text = "FTS5 queries need sanitization — special chars (quotes, parens, +, -, ^, :) and reserved words (OR, AND, NOT, NEAR) cause MATCH failures. sanitize_fts_query() strips them before all FTS calls."
mentions = [
    "src/store/chunks.rs",
    "FTS5",
    "sanitize_fts_query",
]

[[note]]
sentiment = 0.5
text = "Embedder clear_session() releases ~500MB ONNX session memory for long-running processes. Session lazily re-initializes on next embed call. Use during idle periods in watch mode."
mentions = [
    "src/embedder.rs",
    "clear_session",
    "Mutex",
]

[[note]]
sentiment = -0.5
text = '''WSL vhdx doesn't auto-shrink. Deleting files inside WSL frees space on ext4 but the vhdx on C: stays the same size. Must wsl --shutdown + diskpart compact vdisk to reclaim Windows disk space. Our vhdx is at C:\Users\user001\AppData\Local\wsl\{830cd9dc-...}\ext4.vhdx (180GB allocated, ~69GB used).'''
mentions = [
    "WSL",
    "disk-space",
]

[[note]]
sentiment = -0.5
text = "HNSW checksum is mandatory — missing checksum returns error, not warning. hnsw_rs uses bincode 1.3.3 (unmaintained, RUSTSEC-2025-0141) which deserializes unverified bytes. Blake3 checksums on save/load mitigate this. verify_hnsw_checksums validates extension allowlist to prevent path traversal. Always regenerate with cqs index --force if checksum missing."
mentions = [
    "src/hnsw/persist.rs",
    "blake3",
]

[[note]]
sentiment = 0.5
text = "Brute-force search uses cursor batching (5000 rows, WHERE rowid > N) not fetch_all(). Peak memory O(batch) not O(total). Same pattern as EmbeddingBatchIterator in store/chunks.rs. futures crate was removed so can't use sqlx streaming."
mentions = [
    "src/search.rs",
    "brute-force",
]

[[note]]
sentiment = 0.5
text = "Pre-audit security sweep found 10 issues in code that passed 3 prior audits. Different lens (attacker mindset vs code quality) catches different bugs. Run security-focused review separately from quality audits."
mentions = [
    "audit",
    "security",
]

[[note]]
sentiment = -0.5
text = "CRLF line ending drift in WSL: Edit tool on /mnt/c/ NTFS files can silently introduce CRLF, causing full-file diffs of unchanged files. Always check git diff --stat before committing. Use git checkout -- <file> to restore."
mentions = [
    "WSL",
    "git",
]

[[note]]
sentiment = -0.5
text = "Half-open vs inclusive interval overlap: hunk [start, start+count) vs chunk [line_start, line_end]. Correct: start <= end_inclusive && exclusive_end > start_inclusive. Using >= with exclusive end is the classic off-by-one."
mentions = [
    "src/impact/diff.rs",
    "map_hunks_to_functions",
]

[[note]]
sentiment = 0.5
text = "compute_hints accepts prefetched_caller_count to avoid duplicate get_callers_full() when caller already has the data. Pattern: pass Optional<precomputed> to helper functions that would otherwise re-query."
mentions = [
    "src/impact/hints.rs",
    "compute_hints",
]

[[note]]
sentiment = -0.5
text = "57 stale remote branches accumulated before cleanup. Squash-merge doesn't mark branches as merged in git, so git branch -r --merged misses them. Prune after each release: git remote prune origin."
mentions = [
    "release",
    "git",
]

[[note]]
sentiment = 1.0
text = "7-feature plan executed cleanly across multiple sessions. Plan file structure (build order, per-feature sections with SQL, structs, files, tests, fresh-eyes findings) was effective. The build-order dependency chain (2→6→5→3→4→1→7) prevented integration conflicts."
mentions = [
    "plans",
    "agent-experience",
]

[[note]]
sentiment = -0.5
text = "WSL inotify over 9P delivers duplicate/delayed events for the same file change, causing watch mode to reindex in a loop. Fix: track last-indexed mtime per file, skip events where mtime hasn't changed."
mentions = [
    "src/cli/watch.rs",
    "WSL",
    "inotify",
]

[[note]]
sentiment = -0.5
text = "Scout note matching: m.ends_with(f) was wrong direction — matched when mention contains file path as suffix. Only f.ends_with(m) with path-component boundary check is correct. General lesson: string suffix matching on paths needs boundary guards."
mentions = [
    "src/scout.rs",
    "note_mention_matches_file",
]

[[note]]
sentiment = 0.5
text = "cqs plan shipped as skill (.claude/skills/cqs-plan/SKILL.md) with 5 task-type templates: add flag, add command, fix bug, add language, refactor. Experiment confirmed: scout+template = 43% faster + more idiomatic than scout alone. Templates provide structural checklist; scout provides codebase-specific conventions. Not a CLI command — pure skill."
mentions = [
    "src/scout.rs",
    "cqs plan",
]

[[note]]
sentiment = 0.5
text = "HNSW save is already crash-safe: blake3 checksums catch all partial-write states, try_load falls back to brute-force. Backup-dir approach would WIDEN crash window (8 renames vs 4). Don't over-engineer crash recovery when detection+rebuild is sufficient."
mentions = ["hnsw/persist.rs"]

[[note]]
sentiment = 0.5
text = "is_test_chunk(name, file) unifies 4 divergent test-detection implementations (scout, impact, where_to_add, store/calls SQL). Name patterns + path patterns in one function. Content markers (#[test], @Test) stay SQL-only in store/calls.rs."
mentions = [
    "src/lib.rs",
    "is_test_chunk",
]

[[note]]
sentiment = 0.5
text = "cqs dead --min-confidence with High/Medium/Low scoring cuts false positives. High = non-method with no callers in active file. Low = method (dynamic dispatch possible). Entry points (main, init, handler) and trait methods (new, build, default) excluded."
mentions = [
    "src/store/calls.rs",
    "DeadConfidence",
]

[[note]]
sentiment = 0.0
text = "HnswIndex::insert_batch only works on HnswInner::Owned variant. Loaded (from disk via self_cell) is immutable. Watch mode must build Owned at startup for incremental inserts. hnsw_rs has no remove API — orphan vectors stay until full rebuild."
mentions = [
    "src/hnsw/mod.rs",
    "insert_batch",
]

[[note]]
sentiment = -0.5
text = "Always check for open PRs before releasing. PR #379 (26 P1 audit fixes) sat open and unmerged for an entire release cycle — fixes landed via later PRs by coincidence. Add 'gh pr list --state open' to pre-release checklist."
mentions = [
    "release",
    "gh",
    "workflow",
]

[[note]]
sentiment = 0.5
text = "Token budgeting greedy knapsack pattern ships across 6 commands. Generic token_pack<T>() in cli/commands/mod.rs with json_overhead_per_item param accounts for JSON envelope tokens (~35/item). Batch tokenization via Embedder::token_counts_batch(). Pattern: sort by score, walk items, accumulate token count + overhead, stop at budget."
mentions = [
    "src/cli/commands/mod.rs",
    "token_pack",
    "src/embedder.rs",
]

[[note]]
sentiment = 0.5
text = "Cross-index gather: seed from reference index, retrieve seed embeddings via get_embeddings_by_ids, search project store with each seed embedding (bridge), BFS-expand bridges via project call graph. Bridge score = project_score * ref_score weights matches by reference relevance."
mentions = [
    "src/gather.rs",
    "gather_cross_index",
]

[[note]]
sentiment = 0.5
text = "Reference-scoped search via --ref flag reuses multi-index infrastructure. search_reference() with apply_weight=false avoids double-attenuating. Pattern works across query, gather, and diff commands with per-command ref loading."
mentions = [
    "src/reference.rs",
    "search_reference",
]

[[note]]
sentiment = 0.5
text = "review_diff() composes 5 primitives (parse_unified_diff, map_hunks_to_functions, analyze_diff_impact, compute_risk_batch, match_notes + staleness) into a single structured payload. Pattern for composition commands: load shared data once (call graph, test chunks), pass to multiple analyses, merge results. Avoids N separate CLI calls."
mentions = [
    "src/review.rs",
    "src/impact/",
]

[[note]]
sentiment = 0.5
text = "Risk scoring entry-point exception: functions with 0 callers AND 0 tests get Medium risk, not Low. Score formula (caller_count * (1 - coverage)) gives 0 for these, which would be Low, but they're likely entry points that need tests. Special-case prevents silent coverage gaps."
mentions = [
    "src/impact/hints.rs",
    "compute_risk_batch",
]

[[note]]
sentiment = 0.5
text = "impact.rs monolith split into src/impact/ directory — types, bfs, hints, analysis, diff, format. extract_call_snippet_from_cache needed pub(super) to cross analysis→diff boundary. Unused type re-exports from mod.rs caught by compiler — only re-export what lib.rs actually needs."
mentions = [
    "src/impact/mod.rs",
    "src/impact/analysis.rs",
]

[[note]]
sentiment = 1.0
text = "v0.12.4 audit release: 61 fixes across 14 categories. Subagent-driven development with opus agents worked well — 11 tasks, each with spec + quality review. Key lesson: design tasks with exclusive file ownership to avoid parallel agent conflicts."
mentions = [
    "audit-triage.md",
    "review.rs",
    "impact",
]

[[note]]
sentiment = -0.5
text = "SQLite 999 variable limit hit in batch inserts — use INSERT_BATCH constants (999/bind_count) and chunk iterations. Applies to calls.rs and chunks.rs batch methods."
mentions = [
    "calls.rs",
    "chunks.rs",
]

[[note]]
sentiment = 0.5
text = "self_cell with #[not_covariant] is the right pattern for hnsw_rs Hnsw<'a> — it's invariant over the lifetime, so covariant access won't compile. Use with_dependent() closure API, not borrow_dependent()."
mentions = [
    "src/hnsw/mod.rs",
    "self_cell",
]

[[note]]
sentiment = -0.5
text = 'score_name_match("foo", "") returns 0.9 because "foo".starts_with("") is always true in Rust. Empty string is a valid prefix of everything. Always guard name-match functions against empty queries.'
mentions = [
    "src/store/helpers.rs",
    "score_name_match",
]

[[note]]
sentiment = -0.5
text = "to_ascii_lowercase() silently passes through non-ASCII chars unchanged — Ü.to_ascii_lowercase() returns Ü, not ü. Use to_lowercase() (returns iterator) via flat_map when Unicode input is possible."
mentions = [
    "src/convert/naming.rs",
    "to_lowercase",
]

[[note]]
sentiment = -0.5
text = '''ort 2.0.0-rc.11: raw ndarray can't be passed to ort::inputs\![]. Must wrap with Tensor::from_array(). Easy to miss — compiler error is 'SessionInputValue trait not satisfied' which doesn't mention Tensor.'''
mentions = [
    "reranker.rs",
    "embedder.rs",
]

[[note]]
sentiment = -0.5
text = "gh release create uses --notes-file not --body-file (unlike gh pr create which uses --body-file). Easy to confuse."
mentions = ["release"]

[[note]]
sentiment = 0.0
text = "Cross-encoder reranking incompatible with multi-index merge — sigmoid scores (0-1) vs cosine/RRF scores are on different scales. Must rerank before merge or skip entirely."
mentions = [
    "reranker.rs",
    "query.rs",
]

[[note]]
sentiment = 0.5
text = "OnceLock pattern for lazy-init in long-running sessions (batch/REPL): Embedder and HNSW/CAGRA index built on first use, cached for session lifetime. Avoids 500ms+ ONNX init per command. Pattern: OnceLock<T> + get_or_init(|| build()). Used in BatchContext."
mentions = [
    "src/cli/batch/mod.rs",
    "OnceLock",
]

[[note]]
sentiment = -0.5
text = 'CI runs without gpu-index feature — functions with params used only inside #[cfg(feature = "gpu-index")] need let _ = param; at top to avoid unused variable warnings in CI.'
mentions = [
    "src/cli/batch/mod.rs",
    "CI",
    "gpu-index",
]

[[note]]
sentiment = 0.5
text = "Pipeline syntax for batch: shell_words tokenize first, then split by standalone | token. Quote-safe by design — pipes inside quoted strings are a single token, never a separator. Fan-out capped at 50 names/stage with any_truncated tracking across all stages."
mentions = [
    "src/cli/batch/mod.rs",
    "pipeline",
]

[[note]]
sentiment = -0.5
text = "Tree-sitter query patterns must be verified against actual AST dumps (tree.root_node().to_sexp()) — grammar docs are unreliable. Found 3 bugs: Rust trait_bound vs trait_bounds, Go interface types wrapped in type_elem, Go type_alias vs type_spec. Regression test test_type_queries_compile catches this."
mentions = [
    "src/language/rust.rs",
    "src/language/go.rs",
    "src/parser/calls.rs",
]

[[note]]
sentiment = -0.5
text = "pub(crate) items can't be re-exported as pub from lib.rs — compiler error E0364. If a constant/type needs to cross the lib→binary crate boundary, it must be pub. COMMON_TYPES hit this in Phase 1b."
mentions = [
    "src/focused_read.rs",
    "src/lib.rs",
]

[[note]]
sentiment = -0.5
text = "resolve_target picks test functions over production code for ambiguous names. search_filtered resolves to test_search_filtered_empty_store, not Store::search_filtered. Phase 1b trials all showed zero type_impacted until using unique names like open_project_store or cmd_impact_diff."
mentions = [
    "src/search.rs",
    "resolve_target",
]

[[note]]
sentiment = 0.5
text = "Always filter COMMON_TYPES before get_type_users_batch(). Without it, querying users of String/Vec/Result returns most of the codebase. COMMON_TYPES set in focused_read.rs (~35 stdlib types), re-exported from lib.rs."
mentions = [
    "src/focused_read.rs",
    "COMMON_TYPES",
    "type_edges",
]

[[note]]
sentiment = 0.5
text = "Note-boosted search ranking: note_boost() in search.rs applies ±15% score adjustment when note mentions match a chunk's file or name. Strongest absolute sentiment wins across multiple matches. Wired into both brute-force and HNSW-guided paths. Loads notes once per search via list_notes_summaries()."
mentions = [
    "src/search.rs",
    "note_boost",
]

[[note]]
sentiment = -0.5
text = "OnceLock::get_or_try_init is still unstable (nightly-only). For fallible lazy init, use manual pattern: check get(), compute Result, set(), get().unwrap(). See BatchContext::file_set() for the pattern."
mentions = [
    "src/cli/batch/mod.rs",
    "OnceLock",
]

[[note]]
sentiment = 1.0
text = "Parent type context injection improves method search significantly. E5 Recall@1 went from 86% to 90.9%, MRR from 0.885 to 0.941 on hard eval (55 confusable queries). Methods like should_allow() now get 'circuit breaker method' in their NL description. Extraction covers 6 languages: Rust impl/trait, Python class, JS/TS/Java class, Go receiver."
mentions = [
    "src/parser/chunk.rs",
    "src/nl.rs",
    "parent_type_name",
]

[[note]]
sentiment = -0.5
text = "TypeScript is the weakest language for embedding search — 0.75 MRR vs 1.0 for Rust/Python/Go. Class constructors interfere: CircuitBreaker class ranks 15th for its own query because TS chunks include constructor as a separate method with the class name."
mentions = [
    "tests/model_eval.rs",
    "TypeScript",
    "embedding",
]

[[note]]
sentiment = -0.5
text = "HNSW tests are non-deterministic — never assert exact top-1 on small indexes. Use top-k contains instead. Fixed 3 flaky tests in build.rs, safety.rs, hnsw_test.rs."
mentions = [
    "src/hnsw/build.rs",
    "src/hnsw/safety.rs",
    "tests/hnsw_test.rs",
]

[[note]]
sentiment = -0.5
text = "Embedding::new() dimension check must allow MODEL_DIM (768) as valid — the embedding pipeline creates 768-dim vectors before appending sentiment to make 769. Only warn on truly wrong dimensions."
mentions = ["src/embedder.rs"]

[[note]]
sentiment = -0.5
text = "Command listings drift across docs. 6 files have independent command lists (README, CLAUDE.md, bootstrap template, audit agent block, red-team agent block, CLAUDE.md agent instructions). When adding a CLI command, update all 6."
mentions = [
    "README.md",
    "CLAUDE.md",
    ".claude/skills/audit/SKILL.md",
    ".claude/skills/cqs-bootstrap/SKILL.md",
]

[[note]]
sentiment = 1.0
text = "C# language support shipped in v0.15.0. 10th language. New ChunkType variants: Property, Delegate, Event. Per-language common_types on LanguageDef. Data-driven container extraction. tree-sitter-c-sharp 0.23 behind lang-csharp feature flag."
mentions = [
    "src/language/csharp.rs",
    "src/language/mod.rs",
]

[[note]]
sentiment = 0.5
text = "Adding a new language is now data-driven: one-line define_languages! entry, fill LanguageDef struct (queries, stopwords, common_types, container_body_kinds), done. No parser dispatch edits needed. Property/Delegate/Event ChunkType variants ready for reuse."
mentions = [
    "src/language/mod.rs",
    "src/parser/chunk.rs",
]

[[note]]
sentiment = 0.5
text = "Macro ChunkType added for Rust macro_rules! definitions. Also fixed pre-existing gap: property/delegate/event missing from calls.rs definition filter — those chunk types had call extraction silently skipped in parse_file_relationships."
mentions = [
    "src/language/mod.rs",
    "src/parser/calls.rs",
    "ChunkType",
]
