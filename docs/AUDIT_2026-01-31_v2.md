# Deep Design Audit - 2026-01-31 (v2)

Comprehensive audit of `DESIGN.md` (version 0.6.2-draft) covering security, performance, edge cases, dependencies, and UX.

## Summary

| Category | Critical | High | Medium | Low | Total |
|----------|----------|------|--------|-----|-------|
| Security | 0 | 3 | 5 | 6 | 14 |
| Performance | 0 | 3 | 6 | 3 | 12 |
| Edge Cases | 0 | 4 | 5 | 4 | 13 |
| Dependencies | 0 | 0 | 2 | 2 | 4 |
| UX/API | 0 | 2 | 6 | 8 | 16 |
| **Total** | **0** | **12** | **24** | **23** | **59** |

---

## Security Findings

### HIGH

**S1. Path traversal not validated**
- Files read without verifying they're within project root
- Symlinks could escape to `/etc/passwd` etc.
- Fix: Canonicalize paths, verify prefix matches project root

**S2. Model checksum verification unimplemented**
- Design claims SHA256 verification but no code shown
- Malicious model could be served via MITM (unlikely but possible)
- Fix: Implement checksum verification after download

**S3. No symlink policy defined**
- Symlink loops → infinite recursion
- Symlink escape → index files outside project
- Fix: Default to skip symlinks, or follow with cycle detection

### MEDIUM

**S4. SearchFilter `path_pattern` needs parameterized query**
- If glob pattern used in SQL LIKE, injection possible
- Fix: Do glob matching in Rust, not SQL

**S5. Large file memory exhaustion**
- `read_to_string` on multi-GB file → OOM
- Fix: Check file size before reading, skip >1MB

**S6. Brute-force search loads all embeddings**
- 100k chunks × 3KB = 300MB per search
- Fix: Stream results, or use HNSW (Phase 4)

**S7. WAL files not in .gitignore**
- `.cq/index.db-wal` and `.db-shm` would be committed
- Fix: Update gitignore pattern

**S8. Pre-release ort dependency**
- 2.0.0-rc.11 less scrutinized than stable
- Fix: Update to stable when released

---

## Performance Findings

### HIGH

**P1. Full index load for every search**
- All chunks loaded into Vec before scoring
- 50k chunks = 175MB+ memory spike per query
- Fix: Stream rows, fetch content only for top-N

**P2. Brute-force O(n) search**
- 100k chunks = 150-300ms per query
- Fix: HNSW index for Phase 4

**P3. Per-chunk SQLite writes**
- Individual INSERTs without batching
- 10x slower than batch inserts
- Fix: Wrap in transactions, batch 500-1000 chunks

### MEDIUM

**P4. No dynamic batching by token length**
- One long chunk forces entire batch to pad
- 30-50% wasted GPU compute
- Fix: Sort by length, bucket into groups

**P5. Sequential file processing**
- No parallelism during indexing
- Fix: Use rayon for parallel parsing

**P6. Re-embedding unchanged files**
- content_hash check requires parsing first
- Fix: Store file mtime, skip parsing if unchanged

**P7. Per-row embedding deserialization**
- BLOB to Vec<f32> conversion per chunk
- Fix: Use bytemuck for zero-copy

**P8. Naive cosine similarity**
- Could be 2-4x faster with SIMD
- Fix: Use `simsimd` or manual SIMD

**P9. Model loading latency**
- 1-5 second cold start
- Fix: Lazy load for non-embedding commands

---

## Edge Case Findings

### HIGH

**E1. Non-UTF8 files crash indexing**
- `read_to_string` fails on binary/Latin-1 files
- Fix: Catch per-file, log warning, continue

**E2. Multiple `cq index` processes**
- Both may insert same files → duplicates
- Fix: Advisory file lock on `.cq/index.lock`

**E3. Schema version mismatch**
- Old binary + new index = undefined behavior
- Fix: Check version on open, require upgrade

**E4. Model version mismatch**
- Query embeddings incompatible with stored
- Fix: Check model_name on query, warn if different

### MEDIUM

**E5. Empty query string**
- `cq ""` embeds empty string, garbage results
- Fix: Validate query length > 0

**E6. No indexable files found**
- Creates empty index, confusing
- Fix: Warn "No supported files found"

**E7. Ctrl+C during index**
- Partial index state
- Fix: SIGINT handler, commit transaction, exit cleanly

**E8. Disk full during write**
- Partial database state
- Fix: WAL helps; check space before large ops

**E9. Deeply nested code**
- Stack overflow in parent traversal
- Fix: Add depth limit (50 levels)

---

## Dependency Findings

### MEDIUM

**D1. glob 0.3 unmaintained**
- No updates since 2016
- Fix: Consider `globset` for active maintenance

**D2. tree-sitter 0.26 may not exist**
- Latest appears to be 0.25.x
- Fix: Verify version, update if needed

### LOW

**D3. rusqlite 0.31 outdated**
- Latest is 0.38.0
- Fix: Update when convenient

**D4. indicatif 0.17.12 yanked**
- Should use 0.17.11 or 0.18.x
- Fix: Pin to working version

---

## UX/API Findings

### HIGH

**U1. Exit codes not documented**
- Can't script reliably without knowing codes
- Fix: Define 0=success, 1=error, 2=no results, etc.

**U2. JSON output schema undefined**
- `--json` exists but format not specified
- Fix: Document schema

### MEDIUM

**U3. Error messages not actionable**
- "Unsupported file type" doesn't list supported types
- Fix: Include hint in all errors

**U4. No --force flag for index**
- Can't force re-index without deleting .cq/
- Fix: Add `cq index --force`

**U5. No --dry-run for index**
- Can't preview what would be indexed
- Fix: Add `cq index --dry-run`

**U6. Query syntax undocumented**
- Case sensitive? Quotes? Boolean operators?
- Fix: Document query syntax

**U7. --lang accepted values unclear**
- Is it "rust" or "rs" or "Rust"?
- Fix: Document and show in help

**U8. No environment variable overrides**
- Can't configure in CI/Docker easily
- Fix: Add CQ_* env vars

### LOW

**U9. Library API uses `&Path` not `impl AsRef<Path>`**
- Inconsistent with project conventions
- Fix: Update signatures

**U10. No builder pattern for Embedder/Store**
- Hard to configure programmatically
- Fix: Add builders

**U11. ChunkSummary and ModelInfo undefined**
- Referenced but never defined
- Fix: Add struct definitions

**U12-U16.** Various minor naming/consistency issues

---

## Priority Action Items

### Before MVP (Must Fix)

1. **Path validation** - Canonicalize, verify within project root
2. **File size limit** - Skip files >1MB
3. **File lock** - Prevent concurrent `cq index`
4. **UTF-8 error handling** - Skip non-UTF8 with warning
5. **Schema/model version check** - On every DB open
6. **Batch SQLite inserts** - Transaction per 500-1000 chunks
7. **Exit codes** - Document standard codes
8. **Empty query validation** - Reject empty/whitespace

### Phase 1 Polish

9. **Symlink policy** - Skip by default
10. **Model checksum** - Verify SHA256 after download
11. **SIGINT handler** - Graceful shutdown
12. **Parallel parsing** - rayon for file processing
13. **mtime caching** - Skip unchanged files
14. **WAL gitignore** - Add *.db-wal, *.db-shm
15. **--force and --dry-run** - Add to index command
16. **JSON schema** - Document output format

### Phase 2+

17. **HNSW index** - For >50k chunks
18. **Streaming search** - Don't load all into memory
19. **SIMD cosine** - 2-4x faster similarity
20. **Dynamic batching** - Group by token length
21. **Builder patterns** - Embedder, Store
22. **Env var config** - CQ_* overrides

---

## Verified Safe

- SQL queries are parameterized (static strings)
- No code injection vectors (no eval, static tree-sitter queries)
- HTTPS for model download (hf-hub)
- All dependencies MIT/Apache-2.0 compatible
- No known CVEs in specified versions
- tree-sitter widely audited (GitHub, Helix, Zed)
